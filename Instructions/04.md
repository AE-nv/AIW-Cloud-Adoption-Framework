# Exercise 4: Azure Server Management Services

## Overview
Azure server management services provide a consistent experience for managing servers at scale. These services cover both Linux and Windows operating systems. They can be used in production, development, and test environments. The server management services can support Azure IaaS virtual machines, physical servers, and virtual machines that are hosted on-premises or in other hosting environments.

In this exercise you will cover how to Onboard Change Tracking,Inventory, and Update Management solutions to Azure virtual machine

>Note: To onboard the server management services Azure **Update Management,Change Tracking and Inventory** ,**log analytics workspace, automation account and virtual machine**  are required and these are already provided as pre-requisite in the environment.

#### Task 1: Enable server management services on a Virtual Machine

In this task you will enable all service management services Change Tracking,Inventory and Update Management on a virtual machine.

#### Subtask1: Enable Change Tracking and Inventory on a Virtual Machine

Azure **Change Tracking and Inventory** provide alerts on the configuration state of your hybrid environment and changes to that environment. It can report critical file, service, software, and registry changes that might affect your deployed servers.By default, the Azure Automation inventory service doesn't monitor files or registry settings. The solution does provide a list of registry keys that we recommend for monitoring.

A **Log Analytics workspace** is a unique environment for storing Azure Monitor log data. Each workspace has its own data repository and configuration. Data sources and solutions are configured to store their data in particular workspaces. Azure monitoring solutions require all servers to be connected to a workspace, so that their log data can be stored and accessed.

The management services require an **Azure Automation account**. You use this account, and the capabilities of Azure Automation, to integrate Azure services and other public systems to deploy, configure, and manage your server management processes.

In this section you will enable consistent control and compliance of your VMs with Change Tracking and Inventory.

1. In the upper left corner of the portal window, to open the Resource Groups menu, click the toggle menu icon and then click on **Resource groups**.
    
   ![](images/ex1-resourcegroups.png)
    
    This blade displays all of the resource groups that you have access to the Azure subscriptions.

2. Now select **CAF** resource group from the list of resource groups and then select automation account **autoac-DeploymentID**
   
   ![](images/ex4-1-rgaa.png)

3. From the **Automation account** blade under the **Configuration Management** click on **Inventory** 

   ![](images/ex4-3-inventoryblade.png)
   
4. On the **Automation account|Inventory** page choose the Log Analytics workspace**logan-DeploymentID** and Automation account **autoac-DeploymentID** and click on **Enable** to enable the log analytics workspace for Inventory solution.

   ![](images/ex4-2-inventory.png)
  
5. From the **Automation account|Inventory** blade click on **+Add Azure VMs**,this will open up a new page **Enable Inventory**
   
   ![](images/ex4-4-addvm.png)

6. On the **Enable Inventory** page choose the subscription **Sub 05** and resource group **CAF** then select the virtual machine **labvm-DeploymentID** and click on **Enable** to add the virtual machine to enable Change Tracking and Inventory on a Virtual Machine.
   
   ![](images/ex4-5-enablevm.png)
   
  > Note: If you enable Inventory, change tracking will also be enabled.

7. After adding the Virtual machine to Inventory it should show under **Machines** tab.

  ![](images/ex4-machine.png)
   
  >It may take some time for the virtual machine to be reflected under **Machines** tab,You can continue with the lab.

8. Now from the **Automation account| Inventory** blade Click on **Edit Settings** this will redirect you to **Workspace Configuration** page

   ![](images/ex4-6-editsettings.png)

9. On the **Workspace Configuration** page under the **Windows Registry** review the **Registry keys** available.
   
   ![](images/ex4-7-registrationkeys.png)
   
##### Subtask2: Enable Update Management on a Virtual machine

You can use Update Management in Azure Automation to manage operating system updates for your Windows and Linux machines in Azure, in on-premises environments, and in other cloud environments. 

1. Navigate to **autoac-DeploymentID**  **Automation account** blade and under the **Update management** section and then select **Update management**.
 
   ![](images/ex4-updatemanagement.png)

2. On the **Automation account| Update Management** choose the Log Analytics workspace **logan-DeploymentID** and Automation account **autoac-DeploymentID** and click on **Enable** to enable the log analytics workspace for Update management solution.

  ![](images/ex4-enableupdatemgmt.png)

3. From the **Automation account| Update Management**  blade click on **+Add Azure VMs**,this will open up a new page **Enable Update Management**
   
   ![](images/ex4-addvmupdatemgmt.png)

4. On the **Enable Update Management** page choose the subscription **Sub 05** and resource group **CAF** then select the virtual machine **labvm-DeploymentID** and click on **Enable** enable Update Management on a Virtual Machine.
   
   ![](images/ex4-updatemgmtenable.png)
   
   >This will enable update management on a virtual machine to manage operating system updates for your Windows and Linux machines in Azure.

##### Subtask3:Configure file tracking on Windows

When you add a new file or registry key to track, Azure Automation enables it for Change Tracking and Inventory.You can use Change Tracking and Inventory to track changes to files and folders/directories. 

1. Navigate to **autoac-DeploymentID** Automation account blade, select **Change tracking** under **Configuration Management**.

2. Select **Edit Settings** (the gear symbol).
   
   ![](images/ex4-6-editsettings.png)
   
3. On the **Workspace Configuration** page, select **Windows Files**, then click **+ Add** to add a new file to track.
   
   ![](images/ex4-windowsfileadd.png)

4. On the **Add Windows File for Change Tracking pane**, enter the information for the file or folder to track and click **Save**. 
   - Item name: `hosts`
   >Name of the file to be tracked
   
   - Enter path: `C:\windows\system32\drivers\etc\hosts*`
   
   >The path to check for the file
   
   - Path type: Choose **Folder**
   >The type of path: Possible values are File and Folder.

   - Recursion: **On**
   >True if recursion is used when looking for the item to be tracked, and False otherwise.

   - Upload File content: **True**
   
   >True to upload file content on tracked changes, and False otherwise.
   
   ![](images/ex4-widnowsfilesave.png)

5. Now the next step is to enable tracking for file content changes.
  
  >Note: File content tracking allows you to view the contents of a file before and after a tracked change. The feature saves the file contents to a storage account after each change occurs.
  
6. 0n the **Workspace Configuration** page, switch to **File Content** tab and click on **Link** .This selection opens the **Add Content Location for Change Tracking** page.

   >Linking a storage account is required to save the content of the file modified.
   
    ![](images/ex4-filecontent.png)

6. Next on the **Add Content Location for Change Tracking** blade Select the subscription **Sub 05-DeploymentID** ,select the storage account **StorageDeploymentID** for storing the file contents from the drop down menu and toggle the button to **On** for **Upload file content for all settings** option.

  ![](images/ex4-addcontent.png)
  
7. Select **On** for Upload file content for all settings and then Click on **Save**.

8. Now on the virtual machine navigate to  the path **C:\windows\system32\drivers\etc\hostsC:\windows\system32\drivers\etc\hosts** and open with **Notepad** to edit the file.
   
   ![](images/ex4-path.png)
   
9. Edit the file **hosts** to check how **Change Tracking** tracks the file.
   
   ![](images/ex4-edithosts.png)

10. Now return back to the **autoac-DeploymentID**  **Automation account** blade 

11. From the **autoac-DeploymentID**  **Automation account** page scroll down to **Monitoring** section and select **Logs**.
  
   ![](images/ ex4-logs.png)
   
12. Now on the **Automation account| Logs** blade click on **Select a scope** and set the scope to the virtual machine **labvm-DeploymentID** and click on **Apply**.
  
  ![](images/ex4-logs-vm.png)

13. In Log Analytics, run the following query to search for changes to the hosts file:
    ```
    ConfigurationChange | where FieldsChanged contains "FileContentChecksum" and FileSystemPath contains "hosts"
    ```
   ![](images/ex4-query.png)
   >This query searches for changes to the contents of files that have a path that contains the word "hosts."
   
#### Task 2: Guest Configuration Policy 

In this task you will use the Azure Policy Guest Configuration extension to audit the configuration settings in a virtual machine to verify that password security settings in Windows and Linux computers are set correctly and also to check whether any certificates are about to expire.
Use the PowerShell commands to deploy these policies to:
- Verify that password security settings in Windows and Linux computers are set correctly.
- Verify that certificates aren't close to expiration on Windows VMs.

1. In the Azure portal, open the **Azure Cloud Shell** by clicking on the icon in the top right of the Azure Portal.
   
   ![](images/ex4-cloudshell.png)
   
2. If prompted to select either Bash or PowerShell, select **PowerShell**.

3. Click on **show advanced settings**.

   ![](images/ex4-showadsettings.png)
   
4. In **advanced settings**, select the subscription **Sub 05-DeploymentID** and region **CentralUS** 
   
   ![](images/ex4-settings.png)
   
   Then select **CAF** resource group and choose the **existing storage account**,create a file share and click on **Create Storage**.

5. Ensure you are connected to **Powershell Session**
   
   ![](images/ex4-powershell.png)
   
6. Connect to your azure account by running the command:
   ```
   Connect-AzAccount 
    ```
7. Set the subscription that you want to apply the policies to by running the below command:
   
   ```
   $Subscription = Get-AzSubscription | Where-Object { $_.Name -like "*sub 05*"  } | Sort-Object -Property Name
   $scope = "/subscriptions/" + $Subscription.Id
   ```

8. Assign the available policy definition **Verify that password security settings in Windows and Linux computers are set correctly** by running the below command:
   ```
   $PasswordPolicy = Get-AzPolicySetDefinition -Name "3fa7cbf5-c0a4-4a59-85a5-cca4d996d5a6"
   New-AzPolicyAssignment -Name "PasswordPolicy" -DisplayName "[Preview]: Audit that password security settings are set correctly inside Linux and Windows machines" -Scope     $scope -PolicySetDefinition $PasswordPolicy -AssignIdentity -Location centralus
   ```

 9. Assign the available policy definition **Verify that certificates aren't close to expiration on Windows VMs** by running the below command:
    ```
    $CertExpirePolicy = Get-AzPolicySetDefinition -Name "b6f5e05c-0aaa-4337-8dd4-357c399d12ae"
    New-AzPolicyAssignment -Name "CertExpirePolicy" -DisplayName "[Preview]: Audit that certificates are not expiring on Windows VMs" -Scope $scope -PolicySetDefinition     $CertExpirePolicy -AssignIdentity -Location centralus
    ```
10. From the Azure portal , type **policy** at the search bar and select **Policy** under services. You will be redirected to **Policy** page.
   
   ![](images/ex4-policy.png)

11. On the **Policy** page select the scope as **sub 05-DeploymentID** and verify the policies applied in the previous steps are successfully assigned.

   ![](images/ex4-policies.png)
   
#### Task 3: Create Update Schedules 

Schedule the installation of updates to ensure that all your servers have the latest ones.You can quickly assess the status of available updates on all agent machines and manage the process of installing required updates for servers. 
You can deploy and install software updates on machines that require the updates by creating a scheduled deployment. Updates classified as optional aren't included in the deployment scope for Windows machines. Only required updates are included in the deployment scope. The scheduled deployment defines which target machines receive the applicable updates

In this task you will schedule update on a virtual machine.

1. Navigate to **Automation account** blade and under the **Update management** section and then select **Update management**.
 
   ![](images/ex4-updatemanagement.png)

2. From the **Automation account| Update Management** page select **+Schedule update deployment** option.
   
   ![](images/ex4-scheduleupdate.png)
 
 3. 


#### Task 4: Enable Tracking and Alerting for Critical Changes

Azure Change Tracking and Inventory provide alerts on the configuration state of your hybrid environment and changes to that environment. It can report critical file, service, software, and registry changes that might affect your deployed servers.

By default, the Azure Automation inventory service doesn't monitor files or registry settings. The solution does provide a list of registry keys that we recommend for monitoring.

1.	Set Alerts on file or registry changes in the VM.

After the query returns the results, select New alert rule to open the alert-rule editor. You can also get to this editor via Azure Monitor in the Azure portal.
