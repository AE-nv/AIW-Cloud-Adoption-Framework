# Exercise 3: Enterprise Scale

## Context

The Enterprise-Scale architecture is modular by design and allow organizations to start with foundational landing zones that support their application portfolios, regardless of whether the applications are being migrated or are newly developed and deployed to Azure. The architecture enables organizations to start as small as needed and scale alongside their business requirements regardless of scale point.
The Wing Tip company want to start with Landing Zones for their workload in Azure, where hybrid connectivity to their on-premise datacenter is not required from the start. 

### Reference architecture

This reference implementation is ideal for customers who want to start with Landing Zones for their workload in Azure, where hybrid connectivity to their on-premise datacenter is not required from the start.

![](images/Refarch-MG.png) 

#### Task 1: Deploy the Management Group structure using ARM template and Policy Set definitions

In this task you are deploying the foundational Management Group structure as well as the policy and PolicySet definitions. To deploy this we will use the Contoso reference implementation ARM template.

1. Click on the **Deploy to Azure** button.

   [![Deploy to Azure button.](images/azure-deploy-button-small.png "Deploy to Azure")](https://portal.azure.com/#blade/Microsoft_Azure_CreateUIDef/CustomDeploymentBlade/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2Fdocs%2Freference%2Fwingtip%2FarmTemplates%2Fes-foundation.json/createUIDefinitionUri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2FEnterprise-Scale%2Fmain%2Fdocs%2Freference%2Fwingtip%2FarmTemplates%2Fportal-es-foundation.json)

2. On the **Custom deployment** blade, in the Basics section, fill in the **Region** and click on **Next: Enterprise Scale Company Prefix.**

   ![](images/Ex3-dep-1.png) 

3. On the **Enterprise Scale Company Prefix** section, provide a company prefix (for this document, we will use **WT** as the prefix, but you can choose the prefix of your preference). Please click **Next: Platform management, security and governance** to move to the next section.

   ![](images/Ex3-dep-2.png) 
   
4. On the **Platform management, security and governance** section **management subscription** and policies need to be configured. Leave the other options set to default.
    And Click on **Next: Next: Landing zone configuration** to move to the next section.
    
   ![](images/Ex3-dep-3.png) 

5. In the **Landing zone configuration** section, your tenant will be enabled to host workload Landing Zones. Configure the section as illustrated in the following screenshot this will deploy the chosen policy assignment at the Landing Zone scope ,Select the **Landing zone subscription**.

   And Click on **Next : Review + create** to move to the next section.
   
   ![](images/Ex3-dep-4.png) 
  
6. After the template has passed the validation click **Create**. This will deploy the initial Management Group structure together with the required Policy/PolicySet definitions. It will also move the subscription under the right Management Group and will also deploy a Log Analytics Workspace and enable platform monitoring. This process will take around 10 minutes to complete. 

   ![](images/Ex3-dep-5.png) 

7. Once the deployment is completed successfully, in the Azure Portal type **Management Groups** into the search box and select the **Management Groups** under services. 

   ![](images/ex3-searchmanagementgrp.png)
 
8. Click on the **WT** Management Group. 
   
    ![](images/ex3-WT.png) 

9. You should see the following Management Groups in your environment:
   
   ![](images/ex3-mgroups.png) 

10. In the **WT** Management Group click on **details**
   
    ![](images/ex3-mgdetails.png) 

11. Next, in the **WT** Management Group click on **Policies** 

    ![](images/ex3-WTpolicy.png) 

12. In the **Policy | Definitions** blade, select the scope **WT** and under **Type** select **Custom** , you will see a list of Initiative and policy definitions as shown below which are assigned at the management group level.
   
    ![](images/ex3-MGpolicy.png) 

#### Task 2: Deploy Resources into ESLZ

#### Create a Key Vault and review Diagnostic settings

After deploying the ESLZ reference implementation (Wingtip), and bringing in a subscription for the platform management, policies are already assigned to ensure resources will have diagnostics/monitoring enabled.

1. In the Azure portal , under **All services** search for **Keyvault** -> **+Add**
   
   ![](images/ex3t2-1.png)
   
2. Create a key vault by providing the following details:
   - Select the subscription **L3- ES Management Sub-Suffix** 
   - Select the resource group named **kvmgmt**
   - Provide the keyvault name : **kvsuffix**
   - Select the region where you want to deploy the key vault 
   - Leave the default options for other details
   
    Click on **Review+Create** to create the key vault.
   
    ![](images/ex3t2-2.png)

3. Once you have started the deployment, monitor the **Activity Log** to see the policy effect. You should see **deployIfNotExists** Policy action and examine the JSON payload
  
   ![](images/ex3t2-3.png)
 
4. Post a successful deployment of the KeyVault, you should start to see (approx. 6-10 minutes) another deployment of the resource appearing in the resource group.
   ![](images/ex3t2-4.png)
  
5. Navigate to key vault you just created and review the **Diagnostics settings**, verify  if it is connected to your **Log Analytics workspace**.

   ![](images/ex3t2-5.png)
   
6. Now, on the keyvault page click on **Insights** under **Monitoring** and explore the Azure Monitor Insights view

   ![](images/ex3t2-6.png)
  
7. Navigate to Azure **Policy** and select the **management group** hosting the management subscription, and review compliance state of the policies.

   Also check the policies that are **non-compliant** in your environment and why?
   
   ![](images/ex3t2-10.png) 

#### Review Policy to your Landing Zone

As you saw in the previous task, policies ensures that security and compliance is being met regardless of how resources are being created. In this exercise, you will assign a new policy to ensure Key Vaults in the landing zones will always have soft-deletion enabled.

1. Navigate to Azure Policy and select the Online management group as scope.
   
   ![](images/ex3t2-7.png)
   
2. Review the the policy definition **Append-KV-SoftDelete** and check what the policy will do on KeyVault resources. Once reviewed, Click on **Assign** to assign the policy to a particular scope.
   
   ![](images/ex3t2-8.png)

3. **Assign** the policy at the **Online** management group scope, and give the assignment a description as **This policy will ensure all key vaults are being created with soft deletion enabled**.

  - Leave the other options default and Click on **Review+Create** for assignment to be successfully applied.
   
    ![](images/ex3t2-9.png)

   In this exercise you deployed the Management Group structure using ARM template and Policy Set definitions and learnt about the Enterprise scale landing zone

   Click on **Next** to proceed for the next exercise.
